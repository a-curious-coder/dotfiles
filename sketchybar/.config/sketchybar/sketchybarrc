#!/usr/bin/env sh

# Minimal, legible bar aligned with kepano-philosophy.md:
# - no decoration or animation
# - fixed workspace set to reduce decision fatigue
# - full date + 24h time
# - Flexoki palette for long sessions

CONFIG_DIR="${CONFIG_DIR:-$HOME/.config/sketchybar}"
PLUGIN_DIR="$CONFIG_DIR/plugins"
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

export SB_COLOR_BG=0xff100f0f
export SB_COLOR_FG=0xffcecdc3
export SB_COLOR_FG_BRIGHT=0xfffffcf0
export SB_COLOR_DIM=0xff6f6e69

export SB_FONT="JetBrainsMono NFM:Regular:12.0"
export SB_FONT_STRONG="JetBrainsMono NFM:Medium:12.0"

sketchybar --bar position=top height=26 display=all topmost=window color="$SB_COLOR_BG" \
                     border_width=0 corner_radius=0 blur_radius=0 \
                     shadow=off padding_left=6 padding_right=6

default=(
  icon.drawing=off
  label.font="$SB_FONT"
  label.color="$SB_COLOR_FG"
  label.padding_left=4
  label.padding_right=4
  padding_left=2
  padding_right=2
  background.drawing=off
)
sketchybar --default "${default[@]}"
sketchybar --remove tasklist >/dev/null 2>&1 || true
sketchybar --remove window_list >/dev/null 2>&1 || true
sketchybar --remove window.list >/dev/null 2>&1 || true
sketchybar --remove windowlist >/dev/null 2>&1 || true
sketchybar --remove clock >/dev/null 2>&1 || true
sketchybar --remove battery >/dev/null 2>&1 || true
for sid in 1 2 3 4 5 6 7 8; do
  sketchybar --remove "clock.$sid" >/dev/null 2>&1 || true
  sketchybar --remove "battery.$sid" >/dev/null 2>&1 || true
done

AEROSPACE_BIN=""
if command -v aerospace >/dev/null 2>&1; then
  AEROSPACE_BIN="aerospace"
elif [ -x "/Applications/AeroSpace.app/Contents/MacOS/AeroSpace" ]; then
  AEROSPACE_BIN="/Applications/AeroSpace.app/Contents/MacOS/AeroSpace"
fi
export AEROSPACE_BIN

WORKSPACES=""
if [ -n "$AEROSPACE_BIN" ]; then
  WORKSPACES="$($AEROSPACE_BIN list-workspaces --all --format '%{workspace}')"
fi
if [ -z "$WORKSPACES" ]; then
  WORKSPACES="1 2 3 4 5 6 7 8 9"
fi

for ws in $WORKSPACES; do
  sketchybar --add item "workspace.$ws" left \
             --set "workspace.$ws" label="$ws" \
                 label.padding_left=6 label.padding_right=6 \
                 script="$PLUGIN_DIR/workspace_item.sh" \
                 scroll_texts=off \
             --subscribe "workspace.$ws" mouse.clicked mouse.scrolled
done

# Hidden updater to keep workspace state accurate without animation.
sketchybar --add item workspace_updater left \
           --set workspace_updater drawing=off \
                script="$PLUGIN_DIR/workspaces.sh" update_freq=1 \
           --subscribe workspace_updater space_change display_change system_woke

# Front app (left)
sketchybar --add item front_app right \
           --set front_app script="$PLUGIN_DIR/front_app.sh" \
                label.max_chars=32 scroll_texts=off \
           --subscribe front_app front_app_switched

# Clock (right, notch-safe)
sketchybar --add item clock right \
           --set clock update_freq=30 script="$PLUGIN_DIR/clock.sh" \
                label.font="$SB_FONT_STRONG" \
                label.color="$SB_COLOR_FG_BRIGHT" \
                label.padding_left=10 \
                label.padding_right=8 \
                scroll_texts=off

"$PLUGIN_DIR/workspaces.sh"
sketchybar --update
