# Core Settings
unbind C-b
set -g prefix C-s
bind C-s send-prefix
# Prevent terminal flow control from stealing C-s before tmux sees it.
set-hook -g client-attached 'run-shell "stty -ixon -ixoff < #{client_tty} >/dev/null 2>&1 || true"'
if-shell -F '#{client_tty}' 'run-shell "stty -ixon -ixoff < #{client_tty} >/dev/null 2>&1 || true"'

set -g set-clipboard on
set -g mouse on

# Terminal Settings
set -g default-terminal "tmux-256color"
# Some launch contexts start tmux with SHELL unset.
if-shell '[ -n "$SHELL" ]' \
  'set -g default-shell "$SHELL"' \
  'set -g default-shell "/bin/sh"'
# Ensure run-shell commands can find brew/system binaries (TPM uses `tmux` internally).
set-environment -g PATH "/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
set -asq terminal-features ',xterm-256color:RGB,screen-256color:RGB,tmux-256color:RGB'
set -ga terminal-overrides ',xterm-256color:Tc'  # Fallback true color for older tmux.
set -g history-limit 50000
set -sg escape-time 10
set -g focus-events on
set -gq allow-passthrough on
set -g xterm-keys on
# setw -g mode-keys vi
set-option -g allow-rename off
set-window-option -g automatic-rename off

# Session Behavior
set -g detach-on-destroy off  # Stay in tmux when closing session
set-environment -gu tmux_conf_new_session_retain_current_path
set -g renumber-windows on
# Auto-name new numeric sessions with lightweight codenames so tabs stay scannable.
set-hook -g session-created 'run-shell "$HOME/Projects/personal/dotfiles/tmux/scripts/tmux-session-codename.sh \"#{hook_session_name}\""'

# Flexoki Theme (Dark) - https://stephango.com/flexoki
flexoki_bg='#100F0F'
flexoki_bg_2='#1C1B1A'
flexoki_ui='#282726'
flexoki_ui_2='#343331'
flexoki_tx='#CECDC3'
flexoki_tx_muted='#878580'
flexoki_tx_faint='#575653'
flexoki_blue='#4385BE'
flexoki_green='#879A39'
flexoki_yellow='#D0A215'

# Window and Pane Configuration
set -g base-index 1                   # Start window numbering at 1
set -g pane-base-index 1             # Start pane numbering at 1
set -g display-panes-time 100000     # Pane numbers display time (ms)
set -g pane-border-status off
set -g pane-border-style "fg=${flexoki_ui_2}"
set -g pane-active-border-style "fg=${flexoki_blue},bg=default"
set -g message-style "fg=${flexoki_tx},bg=${flexoki_bg_2}"
set -g message-command-style "fg=${flexoki_bg},bg=${flexoki_yellow}"
set -g mode-style "fg=${flexoki_bg},bg=${flexoki_yellow}"

# Status Line Settings
set -g status-position top
set -g status-left-length 24
set -g status-right-length 120
set -g status-justify centre
set -g status-interval 60
set -g monitor-activity on
set -g visual-activity off

# Key Bindings - Windows and Panes
bind r source-file ~/.tmux.conf \; display-message "tmux config reloaded"
# Primary keybinding UX via tmux-which-key; fallback to local help popup.
bind ? if-shell '[ -f "$HOME/.tmux/plugins/tmux-which-key/plugin.sh.tmux" ]' \
  'run-shell -b "tmux show-wk-menu-root"' \
  'display-popup -E -w 92% -h 88% "$HOME/Projects/personal/dotfiles/tmux/scripts/tmux-help-popup.sh"'
# Reference help popup (search + preview + copy command).
bind H display-popup -E -w 92% -h 88% "$HOME/Projects/personal/dotfiles/tmux/scripts/tmux-help-popup.sh"
bind c new-window -c "#{pane_current_path}"
bind-key -n F2 new-window -c "#{pane_current_path}"
bind-key -n F5 split-window -h -c "#{pane_current_path}"
bind-key -n F6 split-window -v -c "#{pane_current_path}"
bind-key -n F8 command-prompt -I "#W" "rename-window '%%'"
bind-key -n F11 resize-pane -Z
bind-key -n F12 kill-pane

# Navigation
bind -n M-w choose-tree -Zw
bind -n M-f command-prompt -p "find window" "find-window '%%'"
bind-key -n C-PageDown next-window
bind-key -n C-PageUp previous-window
bind-key -n S-Left resize-pane -L
bind-key -n S-Right resize-pane -R
bind-key -n S-Up resize-pane -U
bind-key -n S-Down resize-pane -D

# Smart Pane Switching with Vim Integration
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

# Popup Utilities
bind -n M-z popup -d '#{pane_current_path}' -E -h 75% -w 83% -x 100% "zsh"
bind -n M-b popup -d '#{pane_current_path}' -E -h 95% -w 95% -x 100% "btop"
bind -n M-g popup -d '#{pane_current_path}' -E -h 95% -w 95% -x 100% "EDITOR=nvim lazygit"

# Session Management
bind -n M-s choose-session
bind -n M-e display-popup -E "session=\$(tmux list-sessions -F '#S' 2>/dev/null | fzf --reverse); [ -n \"\$session\" ] && tmux switch-client -t \"\$session\""
# tmux-fzf command palette is available on prefix+F.
set-environment -g TMUX_FZF_ORDER "session|window|pane|command|keybinding"
set-environment -g TMUX_FZF_OPTIONS "-p -w 70% -h 60% -m"
# tmux-matryoshka (nested tmux control) on root keys:
# M-d disable outer tmux, M-u re-enable inner tmux, M-U re-enable all.
set -g @matryoshka_down_keybind 'M-d'
set -g @matryoshka_up_keybind 'M-u'
set -g @matryoshka_up_recursive_keybind 'M-U'
set -g @matryoshka_inactive_status_style_strategy 'assignment'
set -g @matryoshka_inactive_status_style "bg=${flexoki_ui},fg=${flexoki_tx_muted}"
# tmux-thumbs picker on prefix+T.
set -g @thumbs-key 'T'
set -g @thumbs-osc52 1
set -g @thumbs-bg-color '#100F0F'
set -g @thumbs-fg-color '#CECDC3'
set -g @thumbs-hint-fg-color '#D0A215'

# Minimal status line: session + centered tabs + mode flags + path + time.
set -g status-style "fg=${flexoki_tx},bg=${flexoki_bg}"
set -g status-left "#[fg=${flexoki_blue},bold] #S "
set -g status-right "#[fg=${flexoki_tx_faint}]#{?client_prefix,PREFIX ,}#{?pane_in_mode,COPY ,}#{?window_zoomed_flag,ZOOM ,}#[fg=${flexoki_tx_muted}]#{pane_current_path} #[fg=${flexoki_tx}]%H:%M "
set -g window-status-separator " "
set -g window-status-format "#[fg=${flexoki_tx_faint}] #I:#W "
set -g window-status-current-format "#[fg=${flexoki_bg},bg=${flexoki_blue},bold] #I:#W "
set -g window-style "fg=${flexoki_tx_muted},bg=default"
set -g window-active-style "fg=${flexoki_tx},bg=default"

# Copy mode
set-option -g mode-keys vi
set -g @clipboard_copy_command ''
if-shell 'command -v xclip >/dev/null 2>&1' "set -g @clipboard_copy_command 'xclip -selection clipboard -in'"
if-shell 'command -v wl-copy >/dev/null 2>&1' "set -g @clipboard_copy_command 'wl-copy'"
if-shell 'command -v pbcopy >/dev/null 2>&1' "set -g @clipboard_copy_command 'pbcopy'"
bind-key -T copy-mode-vi y if-shell -F '#{!=:#{@clipboard_copy_command},}' \
  "send -X copy-pipe-and-cancel '#{@clipboard_copy_command}'" \
  "send -X copy-selection-and-cancel"

# Plugins (TPM installs these - run prefix+I after setup)
# Install TPM first: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# Plugin decisions are tracked in docs/tmux-plugin-index-log.md.
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'alexwforsythe/tmux-which-key'
set -g @plugin 'niqodea/tmux-matryoshka'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @tmux-which-key-disable-autobuild 1

set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

if-shell '[ -x "$HOME/Projects/personal/dotfiles/tmux/scripts/tmux-plugin-bootstrap.sh" ]' \
  'run-shell "$HOME/Projects/personal/dotfiles/tmux/scripts/tmux-plugin-bootstrap.sh --auto --quiet"'

run '~/.tmux/plugins/tpm/tpm'
