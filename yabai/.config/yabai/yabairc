#!/usr/bin/env bash
set -u

export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:${PATH:-}"

YABAI_BIN="${YABAI_BIN:-$(command -v yabai || true)}"
if [[ -z "$YABAI_BIN" ]]; then
  exit 0
fi

yabai_cmd() {
  "$YABAI_BIN" -m "$@" >/dev/null 2>&1 || true
}

# Core layout: closest practical match to Hyprland dwindle + preserve_split.
yabai_cmd config layout bsp
yabai_cmd config auto_balance off
yabai_cmd config window_placement first_child
yabai_cmd config split_ratio 0.50

# Keep visuals minimal and predictable.
yabai_cmd config top_padding 0
yabai_cmd config bottom_padding 0
yabai_cmd config left_padding 0
yabai_cmd config right_padding 0
yabai_cmd config window_gap 0
yabai_cmd config external_bar all:26:0
yabai_cmd config mouse_follows_focus off
yabai_cmd config focus_follows_mouse off
yabai_cmd config window_shadow on
yabai_cmd config window_opacity off

# Hard requirement: cmd + drag.
yabai_cmd config mouse_modifier cmd
yabai_cmd config mouse_action1 move
yabai_cmd config mouse_action2 resize

# Keep service state stable across reloads.
for label in sa-load-sa sb-space-changed sb-window-created sb-window-destroyed sb-display-changed; do
  yabai_cmd signal --remove "$label"
done

for label in \
  ws1-brave ws1-chrome ws1-firefox ws1-safari \
  ws2-ghostty ws2-iterm ws2-kitty ws2-alacritty \
  ws4-obsidian ws4-obs \
  ws5-steam ws5-heroic \
  ws6-virt \
  ws7-discord ws7-teams ws7-telegram \
  ws9-spotify ws9-music \
  float-system-settings float-app-store float-auth \
  float-save-as float-open-file float-picture-in-picture; do
  yabai_cmd rule --remove "$label"
done

# Hypr-style workspace routing.
yabai_cmd rule --add label=ws1-brave 'app=^Brave Browser$' space=1
yabai_cmd rule --add label=ws1-chrome 'app=^Google Chrome$' space=1
yabai_cmd rule --add label=ws1-firefox 'app=^Firefox$' space=1
yabai_cmd rule --add label=ws1-safari 'app=^Safari$' space=1

yabai_cmd rule --add label=ws2-ghostty 'app=^Ghostty$' space=2
yabai_cmd rule --add label=ws2-iterm 'app=^iTerm2$' space=2
yabai_cmd rule --add label=ws2-kitty 'app=^kitty$' space=2
yabai_cmd rule --add label=ws2-alacritty 'app=^Alacritty$' space=2

yabai_cmd rule --add label=ws4-obsidian 'app=^Obsidian$' space=4
yabai_cmd rule --add label=ws4-obs 'app=^OBS$' space=4

yabai_cmd rule --add label=ws5-steam 'app=^Steam$' space=5
yabai_cmd rule --add label=ws5-heroic 'app=^Heroic$' space=5

yabai_cmd rule --add label=ws6-virt 'app=^virt-manager$' space=6

yabai_cmd rule --add label=ws7-discord 'app=^Discord$' space=7
yabai_cmd rule --add label=ws7-teams 'app=^Microsoft Teams$' space=7
yabai_cmd rule --add label=ws7-telegram 'app=^Telegram$' space=7

yabai_cmd rule --add label=ws9-spotify 'app=^Spotify$' space=9
yabai_cmd rule --add label=ws9-music 'app=^Music$' space=9

# Float utility/dialog windows similar to Hypr rules.
yabai_cmd rule --add label=float-system-settings 'app=^System Settings$' manage=off
yabai_cmd rule --add label=float-app-store 'app=^App Store$' manage=off
yabai_cmd rule --add label=float-auth 'title=^Authentication Required$' manage=off
yabai_cmd rule --add label=float-save-as 'title=^Save As$' manage=off
yabai_cmd rule --add label=float-open-file 'title=^Open Files$' manage=off
yabai_cmd rule --add label=float-picture-in-picture 'title=^Picture-in-Picture$' manage=off sticky=on

# Keep 9 numbered spaces available and labeled.
"$HOME/.config/yabai/scripts/bootstrap-spaces.sh" >/dev/null 2>&1 || true

# Scripting-addition hooks (active when SIP config/sudoers are ready).
yabai_cmd signal --add label=sa-load-sa event=dock_did_restart action='sudo yabai --load-sa'
if command -v sudo >/dev/null 2>&1; then
  sudo -n "$YABAI_BIN" --load-sa >/dev/null 2>&1 || true
fi

# Keep Sketchybar workspace item state in sync without polling.
yabai_cmd signal --add label=sb-space-changed event=space_changed action='sketchybar --trigger yabai_space_changed'
yabai_cmd signal --add label=sb-window-created event=window_created action='sketchybar --trigger yabai_space_changed'
yabai_cmd signal --add label=sb-window-destroyed event=window_destroyed action='sketchybar --trigger yabai_space_changed'
yabai_cmd signal --add label=sb-display-changed event=display_changed action='sketchybar --trigger yabai_space_changed'
